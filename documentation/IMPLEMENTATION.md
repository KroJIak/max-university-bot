# Реализация Max University Bot

## 1. Функционал каждого сервиса

### 1.1. Bot (bot/) - MAX бот

**Технологии:** Go 1.23+, MAX Bot API Client

**Основной функционал:**

#### Обработка событий
- **MessageCreatedUpdate**: Обработка текстовых сообщений от пользователей
- **MessageCallbackUpdate**: Обработка нажатий на кнопки (callback)
- **BotStartedUpdate**: Обработка первого запуска бота пользователем

#### Навигация
- **Главное меню**: Отображение главной страницы с основными разделами
- **Меню сервисов**: Список доступных сервисов (расписание, преподаватели, новости и т.д.)
- **Меню профиля**: Информация о студенте
- **Навигация назад**: Возврат к предыдущим экранам

#### Отображение данных
- **Расписание**: Отображение расписания занятий на выбранный период
- **Преподаватели**: Список преподавателей с возможностью поиска
- **Новости**: Список новостей университета
- **Профиль студента**: Личные данные студента (ФИО, группа, курс, фото)
- **Карты**: Интерактивные карты корпусов
- **Контакты**: Контактная информация деканатов и кафедр

#### Интеграция с MAX API
- Запросы к MAX API для получения данных студентов
- Обработка ответов и форматирование для отображения
- Обработка ошибок и отображение сообщений пользователю

**API Endpoints (внутренние):**
- `ShowMainPage()` - Отображение главной страницы
- `ShowServicesPage()` - Отображение страницы сервисов
- `ShowProfilePage()` - Отображение профиля студента
- `ShowSchedulePage()` - Отображение расписания
- `ShowNewsPage()` - Отображение новостей
- `HandleCallback()` - Обработка callback от кнопок

---

### 1.2. MAX API (app/) - Центральный API

**Технологии:** Python 3.10+, FastAPI, SQLAlchemy, PostgreSQL

**Основной функционал:**

#### Управление университетами
- **CRUD операции**: Создание, чтение, обновление, удаление университетов
- **Аутентификация**: JWT токены для доступа к защищенным endpoints
- **Multi-tenancy**: Изоляция данных по `university_id`

#### Управление пользователями
- **Регистрация**: Создание пользователей в системе
- **Привязка к университетам**: Связь пользователя с университетом
- **Управление студентами**: Привязка аккаунтов студентов к пользователям

#### Конфигурация University API
- **Настройка base_url**: URL для подключения к University API
- **Настройка endpoints**: Конфигурация endpoints для каждой функции
- **Хранение в БД**: Сохранение конфигурации в таблице `university_config`
- **Валидация**: Проверка корректности конфигурации

#### Проксирование запросов
- **Маршрутизация**: Определение, какой API использовать (University или Ghost)
- **Fallback логика**: Переключение между domain и host:port
- **Обработка ошибок**: Обработка и логирование ошибок запросов

#### Управление данными студентов
- **Логин**: Выполнение логина студента на сайте университета
- **Расписание**: Получение расписания занятий
- **Преподаватели**: Получение списка преподавателей
- **Личные данные**: Получение данных студента
- **Контакты**: Получение контактной информации
- **Платформы**: Получение списка веб-платформ
- **Карты**: Получение карт корпусов

**API Endpoints:**
- `GET /api/v1/health` - Health check
- `POST /api/v1/universities/` - Создание университета
- `GET /api/v1/universities/{id}` - Получение университета
- `POST /api/v1/universities/login` - Аутентификация университета
- `POST /api/v1/users/` - Создание пользователя
- `GET /api/v1/users/{user_id}` - Получение пользователя
- `GET /api/v1/config/` - Получение конфигурации (требует JWT)
- `PUT /api/v1/config/` - Обновление конфигурации (требует JWT)
- `POST /api/v1/proxy/students/login` - Логин студента
- `GET /api/v1/proxy/students/status` - Статус студента
- `GET /api/v1/proxy/students/teachers` - Список преподавателей
- `GET /api/v1/proxy/students/schedule` - Расписание
- `GET /api/v1/proxy/students/personal_data` - Личные данные
- `GET /api/v1/proxy/students/contacts` - Контакты
- `GET /api/v1/proxy/students/platforms` - Платформы
- `GET /api/v1/proxy/students/maps` - Карты

---

### 1.3. Admin Panel (admin-panel/) - Веб-админ-панель

**Технологии:** Flutter Web, Dart, Nginx

**Основной функционал:**

#### Аутентификация
- **Логин**: Вход администратора университета
- **JWT токены**: Сохранение и использование токенов для запросов
- **Валидация**: Проверка корректности учетных данных

#### Настройка конфигурации
- **Base URL**: Настройка URL для University API
- **Endpoints**: Настройка endpoints для каждой функции
- **Автоопределение**: Автоматическое определение endpoints через OpenAPI
- **Включение/отключение**: Управление доступностью функций

#### Ручной ввод данных
- **Преподаватели**: Добавление, редактирование, удаление преподавателей
- **Расписание**: Управление расписанием занятий
- **Новости**: Управление новостями университета
- **Карты**: Управление картами корпусов
- **Студенты**: Управление данными студентов

#### Загрузка CSV
- **Сбор данных**: Сбор всех введенных вручную данных
- **Формирование CSV**: Создание единого CSV файла
- **Отправка в Ghost API**: Загрузка CSV через endpoint `/upload`
- **Валидация**: Проверка корректности данных перед отправкой

#### Управление модулями
- **Просмотр статуса**: Отображение статуса каждого модуля
- **Включение/отключение**: Управление доступностью модулей
- **Мониторинг**: Отображение состояния endpoints

**Экраны:**
- `LoginScreen` - Экран входа
- `MainScreen` - Главный экран с настройками
- `TeachersScreen` - Управление преподавателями
- `ScheduleScreen` - Управление расписанием
- `NewsScreen` - Управление новостями
- `MapScreen` - Управление картами
- `StudentsScreen` - Управление студентами

---

### 1.4. University API (university-app/) - API для web scraping

**Технологии:** Python 3.10+, FastAPI, BeautifulSoup, httpx

**Основной функционал:**

#### Логин студентов
- **Выполнение логина**: Эмуляция браузера для входа на сайт университета
- **Сохранение cookies**: Сохранение cookies сессии в БД
- **Управление сессиями**: Обновление и удаление сессий

#### Web Scraping
- **Парсинг HTML**: Извлечение данных из HTML страниц
- **Обработка AJAX**: Выполнение AJAX запросов для получения данных
- **Кэширование**: Кэширование данных для уменьшения нагрузки

#### Получение данных
- **Личные данные**: Извлечение данных студента из личного кабинета
- **Расписание**: Парсинг расписания занятий
- **Преподаватели**: Получение списка преподавателей
- **Контакты**: Извлечение контактной информации
- **Платформы**: Статический список платформ

**API Endpoints:**
- `POST /students/login` - Логин студента
- `POST /students/personal_data` - Личные данные
- `POST /students/schedule` - Расписание
- `POST /students/teachers` - Список преподавателей
- `POST /students/teacher_info` - Информация о преподавателе
- `POST /students/contacts` - Контакты
- `GET /students/platforms` - Платформы
- `GET /students/maps` - Карты
- `GET /students/news` - Новости

---

### 1.5. Ghost API (ghost-app/) - Резервный API

**Технологии:** Python 3.10+, FastAPI, SQLAlchemy

**Основной функционал:**

#### Симуляция University API
- **Те же endpoints**: Идентичные endpoints, что и University API
- **Та же структура ответов**: Совместимость с MAX API
- **Прозрачная замена**: Автоматическое переключение без изменений в коде

#### Хранение данных
- **Преподаватели**: Хранение данных преподавателей в БД
- **Расписание**: Хранение расписания занятий
- **Новости**: Хранение новостей
- **Карты**: Хранение карт корпусов
- **Контакты**: Хранение контактной информации

#### Загрузка данных
- **Прием CSV**: Загрузка CSV файлов через multipart/form-data
- **Парсинг CSV**: Обработка различных форматов CSV
- **Импорт в БД**: Сохранение данных в соответствующие таблицы
- **Валидация**: Проверка корректности данных

**API Endpoints:**
- `POST /students/teachers` - Список преподавателей
- `POST /students/schedule` - Расписание
- `POST /students/personal_data` - Личные данные
- `POST /students/contacts` - Контакты
- `GET /students/platforms` - Платформы
- `GET /students/maps` - Карты
- `POST /upload` - Загрузка CSV файлов

---

### 1.6. Mini App (mini-app/) - Веб-приложение

**Технологии:** React, TypeScript, Vite

**Основной функционал:**

#### Расширенный интерфейс
- **Богатый UI**: Интерактивные компоненты и анимации
- **Графики**: Визуализация данных (расписание, статистика)
- **Адаптивный дизайн**: Работа на всех устройствах

#### Интеграция с MAX
- **MAX WebApp API**: Использование API для доступа к данным пользователя
- **Интеграция с ботом**: Связь с ботом для навигации

#### Взаимодействие с MAX API
- **Запросы данных**: Получение данных через MAX API
- **Отображение**: Форматирование и отображение данных
- **Обработка ошибок**: Обработка и отображение ошибок

---

### 1.7. PostgreSQL - База данных

**Версия:** PostgreSQL 15

**Базы данных:**

#### maxbot_db (MAX API)
- `universities` - Университеты
- `users` - Пользователи MAX
- `student_credentials` - Связь пользователей и студентов
- `university_config` - Конфигурация University API

#### university_db (University API)
- `session_cookies` - Cookies сессий студентов
- Кэшированные данные

#### ghost_db (Ghost API)
- `teachers` - Преподаватели
- `schedule` - Расписание
- `news` - Новости
- `maps` - Карты корпусов
- `contacts` - Контакты

---

## 2. Блок-схема связей между сервисами

```
┌─────────────────────────────────────────────────────────────────┐
│                         MAX Users                                │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             │ HTTP/WebSocket
                             ▼
                    ┌─────────────────┐
                    │   MAX Platform  │
                    │  (MAX Bot API)  │
                    └────────┬────────┘
                             │
                             │ Webhook/Callback
                             ▼
        ┌────────────────────────────────────────┐
        │          Bot (Go)                      │
        │  - Обработка сообщений                 │
        │  - Навигация                           │
        │  - Отображение данных                  │
        └────────────┬───────────────────────────┘
                     │
                     │ HTTP REST API
                     │ (GET/POST /api/v1/proxy/*)
                     ▼
        ┌────────────────────────────────────────┐
        │        MAX API (Python FastAPI)        │
        │  - Управление университетами           │
        │  - Управление пользователями           │
        │  - Конфигурация                        │
        │  - Проксирование запросов              │
        └──────┬──────────────┬──────────────────┘
               │              │
               │              │ HTTP REST API
               │              │ (JWT Auth)
               │              ▼
               │   ┌──────────────────────────┐
               │   │   Admin Panel (Flutter)  │
               │   │  - Настройка конфигурации│
               │   │  - Ручной ввод данных    │
               │   │  - Загрузка CSV          │
               │   └───────────┬──────────────┘
               │               │
               │               │ HTTP REST API
               │               │ (POST /upload)
               │               ▼
               │   ┌──────────────────────────┐
               │   │   Ghost API (FastAPI)    │
               │   │  - Хранение данных       │
               │   │  - Загрузка CSV          │
               │   └───────────┬──────────────┘
               │               │
               │               │ SQL
               │               ▼
               │   ┌──────────────────────────┐
               │   │   PostgreSQL (ghost_db)  │
               │   └──────────────────────────┘
               │
               │ HTTP REST API
               │ (Fallback: domain → host:port)
               │
               ├───────────────────────────────┐
               │                               │
               ▼                               ▼
   ┌──────────────────────┐      ┌──────────────────────┐
   │  University API      │      │    Mini App          │
   │  (Python FastAPI)    │      │  (React/TypeScript)  │
   │  - Web Scraping      │      │  - Расширенный UI    │
   │  - Логин студентов   │      │  - Графики           │
   │  - Получение данных  │      └──────────┬───────────┘
   └──────────┬───────────┘                 │
              │                              │
              │ SQL                          │ HTTP REST API
              ▼                              │ (GET /api/v1/proxy/*)
   ┌──────────────────────┐                 │
   │  PostgreSQL          │                 │
   │  (university_db)     │                 │
   └──────────────────────┘                 │
                                            │
                                            ▼
                              ┌──────────────────────┐
                              │     MAX API          │
                              │  (Проксирование)     │
                              └──────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    Общая база данных                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  maxbot_db   │  │ university_db│  │   ghost_db   │         │
│  │  (MAX API)   │  │(University)  │  │  (Ghost API) │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

**Легенда:**
- `───` - HTTP REST API
- `═══` - SQL запросы
- `───▶` - Направление запроса

---

## 3. Sequence Diagrams (Диаграммы последовательности)

### 3.1. Сценарий: Получение расписания студента

```
User          Bot          MAX API        University API    PostgreSQL
 │             │              │                 │               │
 │  ──────────▶│              │                 │               │
 │  "Расписание"              │                 │               │
 │             │              │                 │               │
 │             │  ───────────▶│                 │               │
 │             │  GET /api/v1/                 │               │
 │             │  proxy/students/schedule      │               │
 │             │              │                 │               │
 │             │              │  ──────────────▶│               │
 │             │              │  Проверка       │               │
 │             │              │  конфигурации   │               │
 │             │              │                 │               │
 │             │              │  ──────────────▶│               │
 │             │              │  SELECT config  │               │
 │             │              │  FROM           │               │
 │             │              │  university_config              │
 │             │              │◀────────────────│               │
 │             │              │  config         │               │
 │             │              │                 │               │
 │             │              │  ──────────────▶│               │
 │             │              │  POST /students/│               │
 │             │              │  schedule       │               │
 │             │              │                 │               │
 │             │              │                 │  ────────────▶│
 │             │              │                 │  SELECT      │
 │             │              │                 │  cookies     │
 │             │              │                 │◀────────────│
 │             │              │                 │  cookies     │
 │             │              │                 │               │
 │             │              │                 │  ────────────▶│
 │             │              │                 │  HTTP Request│
 │             │              │                 │  к сайту     │
 │             │              │                 │  университета│
 │             │              │                 │◀─────────────│
 │             │              │                 │  HTML/JSON   │
 │             │              │                 │               │
 │             │              │◀────────────────│               │
 │             │              │  schedule data  │               │
 │             │◀─────────────│                 │               │
 │             │  schedule    │                 │               │
 │◀────────────│              │                 │               │
 │  Расписание │              │                 │               │
 │             │              │                 │               │
```

### 3.2. Сценарий: Настройка конфигурации через Admin Panel

```
Admin         Admin Panel    MAX API        PostgreSQL
 │                 │             │               │
 │  ──────────────▶│             │               │
 │  Открывает      │             │               │
 │  админ-панель   │             │               │
 │                 │             │               │
 │                 │  ──────────▶│               │
 │                 │  POST       │               │
 │                 │  /api/v1/   │               │
 │                 │  universities/login         │
 │                 │             │               │
 │                 │             │  ────────────▶│
 │                 │             │  SELECT      │
 │                 │             │  university  │
 │                 │             │◀─────────────│
 │                 │             │  university  │
 │                 │◀────────────│               │
 │                 │  JWT token  │               │
 │                 │             │               │
 │  ──────────────▶│             │               │
 │  Настраивает    │             │               │
 │  endpoints      │             │               │
 │                 │             │               │
 │                 │  ──────────▶│               │
 │                 │  PUT        │               │
 │                 │  /api/v1/   │               │
 │                 │  config     │               │
 │                 │  (JWT)      │               │
 │                 │             │               │
 │                 │             │  ────────────▶│
 │                 │             │  UPDATE      │
 │                 │             │  university_config│
 │                 │             │◀─────────────│
 │                 │             │  OK          │
 │                 │◀────────────│               │
 │                 │  Success    │               │
 │◀────────────────│             │               │
 │  Конфигурация   │             │               │
 │  сохранена      │             │               │
 │                 │             │               │
```

### 3.3. Сценарий: Загрузка данных в Ghost API

```
Admin         Admin Panel    Ghost API      PostgreSQL
 │                 │             │               │
 │  ──────────────▶│             │               │
 │  Вводит данные  │             │               │
 │  преподавателей │             │               │
 │                 │             │               │
 │  ──────────────▶│             │               │
 │  Нажимает       │             │               │
 │  "Сохранить"    │             │               │
 │                 │             │               │
 │                 │  Собирает   │               │
 │                 │  данные в   │               │
 │                 │  CSV        │               │
 │                 │             │               │
 │                 │  ──────────▶│               │
 │                 │  POST       │               │
 │                 │  /upload    │               │
 │                 │  (multipart)│               │
 │                 │             │               │
 │                 │             │  Парсит CSV   │
 │                 │             │               │
 │                 │             │  ────────────▶│
 │                 │             │  INSERT INTO │
 │                 │             │  teachers    │
 │                 │             │◀─────────────│
 │                 │             │  OK          │
 │                 │◀────────────│               │
 │                 │  Success    │               │
 │◀────────────────│             │               │
 │  Данные         │             │               │
 │  загружены      │             │               │
 │                 │             │               │
```

### 3.4. Сценарий: Логин студента

```
User          Bot          MAX API        University API    PostgreSQL
 │             │              │                 │               │
 │  ──────────▶│              │                 │               │
 │  "Войти"    │              │                 │               │
 │             │              │                 │               │
 │◀────────────│              │                 │               │
 │  Запрос     │              │                 │               │
 │  email/     │              │                 │               │
 │  password   │              │                 │               │
 │             │              │                 │               │
 │  ──────────▶│              │                 │               │
 │  email,     │              │                 │               │
 │  password   │              │                 │               │
 │             │              │                 │               │
 │             │  ───────────▶│                 │               │
 │             │  POST        │                 │               │
 │             │  /api/v1/    │                 │               │
 │             │  proxy/      │                 │               │
 │             │  students/   │                 │               │
 │             │  login       │                 │               │
 │             │              │                 │               │
 │             │              │  ──────────────▶│               │
 │             │              │  Проверка       │               │
 │             │              │  конфигурации   │               │
 │             │              │                 │               │
 │             │              │  ──────────────▶│               │
 │             │              │  SELECT config  │               │
 │             │              │◀────────────────│               │
 │             │              │  config         │               │
 │             │              │                 │               │
 │             │              │  ──────────────▶│               │
 │             │              │  POST           │               │
 │             │              │  /students/     │               │
 │             │              │  login          │               │
 │             │              │                 │               │
 │             │              │                 │  ────────────▶│
 │             │              │                 │  HTTP POST   │
 │             │              │                 │  к сайту     │
 │             │              │                 │  университета│
 │             │              │                 │◀─────────────│
 │             │              │                 │  cookies     │
 │             │              │                 │               │
 │             │              │                 │  ────────────▶│
 │             │              │                 │  INSERT INTO │
 │             │              │                 │  session_    │
 │             │              │                 │  cookies     │
 │             │              │                 │◀─────────────│
 │             │              │                 │  OK          │
 │             │              │◀────────────────│               │
 │             │              │  success        │               │
 │             │              │                 │               │
 │             │              │  ──────────────▶│               │
 │             │              │  INSERT/UPDATE  │               │
 │             │              │  student_       │               │
 │             │              │  credentials    │               │
 │             │              │◀────────────────│               │
 │             │              │  OK             │               │
 │             │◀─────────────│                 │               │
 │             │  success     │                 │               │
 │◀────────────│              │                 │               │
 │  "Вход      │              │                 │               │
 │  выполнен"  │              │                 │               │
 │             │              │                 │               │
```

---

## 4. Сценарии использования

### Сценарий 1: Студент получает расписание

**Участники:** Студент, Bot, MAX API, University API, PostgreSQL

**Предусловия:**
- Студент залогинен в системе
- University API настроен и доступен
- Endpoint для расписания настроен в конфигурации

**Шаги:**
1. Студент открывает бота в MAX
2. Нажимает кнопку "Расписание" в главном меню
3. Bot отправляет запрос к MAX API: `GET /api/v1/proxy/students/schedule?user_id=123&date_range=week`
4. MAX API проверяет конфигурацию в БД
5. MAX API определяет, что endpoint настроен, и отправляет запрос к University API
6. University API получает cookies студента из БД
7. University API выполняет запрос к сайту университета с cookies
8. University API парсит HTML и извлекает расписание
9. University API возвращает данные в формате JSON
10. MAX API возвращает данные Bot
11. Bot форматирует и отображает расписание студенту

**Результат:** Студент видит свое расписание на выбранный период

---

### Сценарий 2: Администратор настраивает систему

**Участники:** Администратор, Admin Panel, MAX API, PostgreSQL

**Предусловия:**
- Администратор имеет учетные данные университета
- Admin Panel доступна

**Шаги:**
1. Администратор открывает Admin Panel в браузере
2. Вводит логин и пароль университета
3. Admin Panel отправляет запрос к MAX API: `POST /api/v1/universities/login`
4. MAX API проверяет учетные данные и возвращает JWT токен
5. Администратор переходит в раздел "Конфигурация"
6. Настраивает `base_url` для University API: `https://lk.university.ru`
7. Настраивает endpoint для расписания: `/api/schedule`
8. Admin Panel отправляет конфигурацию: `PUT /api/v1/config` (с JWT токеном)
9. MAX API сохраняет конфигурацию в БД
10. Администратор видит подтверждение об успешном сохранении

**Результат:** Конфигурация сохранена, система готова к использованию

---

### Сценарий 3: Администратор загружает данные вручную

**Участники:** Администратор, Admin Panel, Ghost API, PostgreSQL

**Предусловия:**
- Администратор залогинен в Admin Panel
- Endpoint для преподавателей не настроен (пустой)
- Администратор хочет использовать ручной ввод данных

**Шаги:**
1. Администратор переходит в раздел "Преподаватели"
2. Добавляет преподавателей через форму ввода:
   - ФИО
   - Кафедра
   - Должность
   - Контакты
3. Переходит в раздел "Расписание"
4. Добавляет расписание занятий
5. Нажимает кнопку "Сохранить изменения"
6. Admin Panel собирает все данные в единый CSV файл
7. Admin Panel отправляет CSV на Ghost API: `POST /upload` (multipart/form-data)
8. Ghost API парсит CSV и определяет типы данных по заголовкам
9. Ghost API сохраняет данные в соответствующие таблицы БД
10. Ghost API возвращает подтверждение об успешной загрузке
11. Admin Panel отображает сообщение об успехе

**Результат:** Данные загружены в Ghost API и доступны для студентов

---

### Сценарий 4: Автоматическое переключение на Ghost API

**Участники:** Студент, Bot, MAX API, University API, Ghost API

**Предусловия:**
- Endpoint для преподавателей настроен
- University API временно недоступен
- Данные преподавателей загружены в Ghost API

**Шаги:**
1. Студент запрашивает список преподавателей
2. Bot отправляет запрос к MAX API
3. MAX API проверяет конфигурацию - endpoint настроен
4. MAX API пытается отправить запрос к University API
5. University API не отвечает (таймаут или ошибка)
6. MAX API автоматически переключается на Ghost API
7. MAX API отправляет запрос к Ghost API с заголовком `X-University-Id`
8. Ghost API получает данные из БД
9. Ghost API возвращает данные в том же формате, что и University API
10. MAX API возвращает данные Bot
11. Bot отображает список преподавателей студенту

**Результат:** Студент получает данные, не замечая переключения между API

---

### Сценарий 5: Fallback с domain на host:port

**Участники:** MAX API, University API

**Предусловия:**
- В конфигурации указан domain URL: `https://university-api.example.com`
- Domain временно недоступен
- В переменных окружения указан fallback: `university-api:8001`

**Шаги:**
1. MAX API получает запрос к University API
2. MAX API пытается выполнить запрос к domain URL
3. Запрос не проходит (таймаут или ошибка соединения)
4. MAX API логирует предупреждение
5. MAX API автоматически переключается на fallback URL: `http://university-api:8001`
6. Запрос успешно выполняется через fallback URL
7. MAX API возвращает данные

**Результат:** Система продолжает работать даже при недоступности domain URL

---

## 5. Технические детали взаимодействия

### 5.1. Протоколы и форматы

**HTTP REST API:**
- Протокол: HTTP/1.1, HTTPS
- Формат данных: JSON
- Методы: GET, POST, PUT, DELETE
- Кодировка: UTF-8

**Аутентификация:**
- JWT токены для администраторов
- `X-University-Id` заголовок для Ghost API
- Cookies для сессий студентов

**База данных:**
- PostgreSQL 15
- SQLAlchemy ORM
- Изоляция по `university_id`

### 5.2. Обработка ошибок

**Уровни обработки:**
1. **Bot**: Обработка ошибок от MAX API, отображение сообщений пользователю
2. **MAX API**: Обработка ошибок от University/Ghost API, логирование, fallback
3. **University API**: Обработка ошибок web scraping, валидация данных
4. **Ghost API**: Обработка ошибок парсинга CSV, валидация данных

**Типы ошибок:**
- HTTP ошибки (404, 500, таймауты)
- Ошибки базы данных
- Ошибки валидации данных
- Ошибки парсинга (HTML, CSV)

### 5.3. Логирование

**Уровни логирования:**
- INFO: Обычные операции
- WARNING: Предупреждения (fallback, недоступность сервисов)
- ERROR: Ошибки, требующие внимания
- DEBUG: Детальная информация для отладки

**Что логируется:**
- Все HTTP запросы и ответы
- Ошибки подключения к сервисам
- Переключения между API (University → Ghost)
- Fallback операции (domain → host:port)
- Операции с базой данных

---

## 6. Масштабирование и производительность

### 6.1. Горизонтальное масштабирование

**Сервисы, которые можно масштабировать:**
- Bot: Несколько экземпляров для обработки большего количества запросов
- MAX API: Балансировка нагрузки через load balancer
- University API: Несколько экземпляров для параллельного scraping
- Ghost API: Несколько экземпляров для обработки запросов

**База данных:**
- Репликация для чтения
- Шардирование по `university_id` при необходимости

### 6.2. Оптимизация производительности

**Кэширование:**
- Кэширование конфигурации в MAX API
- Кэширование данных в University API
- Кэширование статических данных в Ghost API

**Асинхронность:**
- Асинхронные HTTP запросы (httpx.AsyncClient)
- Асинхронная обработка в FastAPI
- Асинхронная обработка сообщений в Bot

**Оптимизация запросов:**
- Индексы в БД для быстрого поиска
- Пакетная обработка данных
- Ленивая загрузка данных

---

## Заключение

Max University Bot реализован как микросервисная система с четким разделением ответственности между сервисами. Каждый сервис выполняет свою роль, взаимодействуя с другими через REST API. Система спроектирована для масштабирования, отказоустойчивости и простоты поддержки.

