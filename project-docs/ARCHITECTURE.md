# Архитектура и структура проекта

Описание архитектуры системы, сервисов и структуры проекта.

## 📋 Содержание

- [Архитектура системы](#архитектура-системы)
- [Сервисы](#сервисы)
- [Структура проекта](#структура-проекта)
- [Взаимодействие сервисов](#взаимодействие-сервисов)

## 🏗️ Архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                      MAX Users                               │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
                ┌──────────────┐
                │     MAX      │
                │     Bot      │
                │   (bot/)     │
                └──────┬───────┘
                       │
                       ▼
                ┌──────────────┐
                │   MAX API    │◄──────┐
                │   (app/)     │       │
                └──────┬───────┘       │
                       │               │
        ┌──────────────┼───────────────┼──────────────┐
        │              │               │              │
        ▼              ▼               ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│  University  │ │    Ghost     │ │    Admin     │ │   Mini App   │
│     API      │ │     API      │ │    Panel     │ │  (mini-app/) │
│(university-  │ │ (ghost-app/) │ │(admin-panel/)│ │              │
│   app/)      │ │              │ │              │ │              │
└──────┬───────┘ └──────┬───────┘ └──────────────┘ └──────────────┘
       │                │
       └────────┬───────┘
                │
                ▼
         ┌──────────────┐
         │  PostgreSQL  │
         │   Database   │
         └──────────────┘
```

---

## 🌐 Сервисы

### MAX API (`app/`)

**Назначение:** Центральный API, координирует работу всех компонентов.

**Технологии:** Python 3.10+, FastAPI, SQLAlchemy, PostgreSQL

**Порт:** 8003

**Основные функции:**
- Управление университетами (CRUD, JWT аутентификация)
- Управление пользователями и студентами
- Конфигурация endpoints для University API
- Проксирование запросов к University/Ghost API
- Multi-tenancy (изоляция данных по `university_id`)

**API Endpoints:**
- `/api/v1/health` - Health check
- `/api/v1/universities/` - Управление университетами
- `/api/v1/universities/login` - Аутентификация
- `/api/v1/users/` - Управление пользователями
- `/api/v1/config/` - Конфигурация (требует JWT)
- `/api/v1/proxy/` - Проксирование запросов

---

### Bot (`bot/`)

**Назначение:** MAX бот для взаимодействия с пользователями.

**Технологии:** Go 1.23+, MAX Bot API Client

**Основные функции:**
- Обработка сообщений и callback
- Навигация (главное меню, сервисы, профиль)
- Отображение данных (расписание, преподаватели, новости)
- Интеграция с MAX API

**Структура:**
- `handlers/` - обработчики событий
- `keyboards/` - компоненты клавиатур
- `pages/` - страницы интерфейса
- `services/` - сервисы для работы с API

---

### Admin Panel (`admin-panel/`)

**Назначение:** Веб-интерфейс для настройки конфигурации.

**Технологии:** Flutter Web, Dart, Nginx

**Порт:** 8081

**Основные функции:**
- Аутентификация администраторов (JWT)
- Настройка `base_url` и endpoints для University API
- Ручной ввод данных (преподаватели, расписание)
- Загрузка CSV файлов в Ghost API
- Управление модулями (включение/отключение функций)

**Особенности:**
- Динамическая конфигурация через `config.js` (генерируется из `.env`)
- Автоматическое определение endpoints через OpenAPI
- Fallback логика (domain → host:port)

---

### University API (`university-app/`)

**Назначение:** API для web scraping с сайта университета.

**Технологии:** Python 3.10+, FastAPI, BeautifulSoup, httpx

**Порт:** 8001

**База данных:** `university_db`

**Основные функции:**
- Логин студентов на сайте университета
- Получение данных через web scraping:
  - Личные данные студента
  - Расписание занятий
  - Список преподавателей
  - Контакты деканатов и кафедр
  - Список платформ
- Управление cookies сессий
- Кэширование данных

**API Endpoints:**
- `/students/login` - Логин студента
- `/students/personal_data` - Личные данные
- `/students/schedule` - Расписание
- `/students/teachers` - Список преподавателей
- `/students/teacher_info` - Информация о преподавателе
- `/students/contacts` - Контакты
- `/students/platforms` - Платформы

**Тестовый аккаунт:**
- Email: `test@test.ru`
- Пароль: `test`
- Использует реальные данные студента ЧГУ

---

### Ghost API (`ghost-app/`)

**Назначение:** Резервный API с данными из БД (вместо scraping).

**Технологии:** Python 3.10+, FastAPI, SQLAlchemy

**Порт:** 8004

**База данных:** `ghost_db`

**Основные функции:**
- Симуляция University API (те же endpoints)
- Хранение данных в БД
- Загрузка данных через CSV (`/upload`)

**Когда используется:**
- Функционал включен в админ-панели
- Endpoint не настроен (пустой)
- Администратор загрузил данные через CSV

**API Endpoints:**
- `/students/teachers` - Список преподавателей
- `/students/schedule` - Расписание
- `/students/personal_data` - Личные данные
- `/students/contacts` - Контакты
- `/students/platforms` - Платформы
- `/upload` - Загрузка CSV файлов

---

### Mini App (`mini-app/`)

**Назначение:** Веб-приложение для расширенного функционала (открывается внутри MAX).

**Технологии:** React, TypeScript, Vite

**Порт:** 8002

**Основные функции:**
- Расширенный интерфейс (богатый UI, графики)
- Интеграция с MAX WebApp API
- Взаимодействие с MAX API

**⚠️ Требует CloudPub:** Должен быть доступен через домен `max-miniapp.cloudpub.ru`.

---

### PostgreSQL

**Версия:** PostgreSQL 15

**Порт:** 5432

**Базы данных:**

1. **maxbot_db** - Основная БД для MAX API
   - Университеты
   - Пользователи
   - Конфигурация
   - Студенты

2. **university_db** - БД для University API
   - Сессии студентов (cookies)
   - Кэшированные данные

3. **ghost_db** - БД для Ghost API
   - Данные преподавателей
   - Данные расписания
   - Другие данные из CSV

---

## 📁 Структура проекта

```
Max-University-Bot/
├── app/                      # MAX API (основной API)
│   ├── api/v1/              # API endpoints
│   ├── core/                 # Настройка БД, утилиты
│   ├── models/              # SQLAlchemy модели
│   ├── repositories/        # Репозитории для работы с БД
│   ├── services/            # Бизнес-логика
│   └── main.py              # Точка входа FastAPI
│
├── bot/                      # MAX бот
│   ├── api/                 # Обертка над MAX Bot API
│   ├── handlers/            # Обработчики событий
│   ├── keyboards/            # Компоненты клавиатур
│   ├── pages/               # Страницы интерфейса
│   └── main.go              # Точка входа
│
├── admin-panel/              # Админ-панель (Flutter Web)
│   ├── lib/
│   │   ├── screens/         # Экраны приложения
│   │   ├── services/        # Сервисы для работы с API
│   │   └── main.dart        # Точка входа
│   └── web/                 # Веб-ресурсы
│
├── university-app/           # University API
│   ├── api/                 # Endpoints
│   ├── services/            # Web scraping логика
│   ├── models/              # SQLAlchemy модели
│   └── main.py              # Точка входа
│
├── ghost-app/                # Ghost API
│   ├── api/                 # Endpoints
│   ├── services/            # Парсинг CSV
│   ├── models/              # SQLAlchemy модели
│   └── main.py              # Точка входа
│
├── mini-app/                 # Mini App (React)
│   ├── src/
│   │   ├── components/      # React компоненты
│   │   ├── pages/           # Страницы
│   │   └── main.tsx         # Точка входа
│   └── vite.config.ts       # Конфигурация Vite
│
├── migrations/               # SQL миграции
├── scripts/                 # Вспомогательные скрипты
├── cloudpub-config/          # Конфигурация CloudPub
├── docker-compose*.yml      # Docker Compose конфигурации
├── .env.example             # Пример переменных окружения
└── README.md                # Главный README
```

---

## 🔄 Взаимодействие сервисов

### Поток запроса от пользователя

1. **Пользователь** отправляет сообщение в MAX
2. **Bot** получает сообщение через MAX Bot API
3. **Bot** отправляет запрос к **MAX API**
4. **MAX API** проверяет конфигурацию:
   - Если endpoint настроен → запрос к **University API**
   - Если endpoint пустой → запрос к **Ghost API**
5. **University API** или **Ghost API** возвращает данные
6. **MAX API** возвращает данные **Bot**
7. **Bot** отображает данные пользователю

### Поток настройки конфигурации

1. **Администратор** открывает **Admin Panel**
2. **Admin Panel** подключается к **MAX API** (аутентификация)
3. **Администратор** настраивает `base_url` и endpoints
4. **Admin Panel** отправляет конфигурацию в **MAX API**
5. **MAX API** сохраняет конфигурацию в БД
6. При запросах **MAX API** использует сохраненную конфигурацию

### Поток загрузки данных в Ghost API

1. **Администратор** открывает **Admin Panel**
2. **Администратор** вводит данные вручную (преподаватели, расписание)
3. **Admin Panel** собирает данные в CSV
4. **Admin Panel** отправляет CSV в **Ghost API** (`/upload`)
5. **Ghost API** парсит CSV и сохраняет в БД
6. При запросах **MAX API** получает данные из **Ghost API**

---

## 📊 Сравнение сервисов

| Сервис | Источник данных | Когда используется | База данных |
|--------|----------------|-------------------|-------------|
| **University API** | Web scraping | Endpoint настроен | `university_db` |
| **Ghost API** | БД (CSV) | Endpoint пустой | `ghost_db` |
| **MAX API** | Проксирование | Всегда | `maxbot_db` |

