services:
  postgres:
    image: postgres:15-alpine
    container_name: maxbot_postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-maxbot}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-maxbot123}
      POSTGRES_DB: ${POSTGRES_DB:-maxbot_db}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-maxbot} -d ${POSTGRES_DB:-maxbot_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    env_file:
      - .env

  api:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: maxbot_api
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgresql://maxbot:maxbot123@postgres:5432/maxbot_db}
      - MAX_API_HOST=${MAX_API_HOST:-0.0.0.0}
      - MAX_API_PORT=${MAX_API_PORT:-8003}
      - MAX_API_DOMAIN_URL=${MAX_API_DOMAIN_URL:-}
    ports:
      - "${MAX_API_PORT:-8003}:${MAX_API_PORT:-8003}"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./app:/app
    env_file:
      - .env

  admin-panel:
    build:
      context: ./admin-panel
      dockerfile: Dockerfile
    container_name: maxbot_admin_panel
    environment:
      - ADMIN_PANEL_HOST=${ADMIN_PANEL_HOST:-0.0.0.0}
      - ADMIN_PANEL_PORT=${ADMIN_PANEL_PORT:-8081}
      - ADMIN_PANEL_DOMAIN_URL=${ADMIN_PANEL_DOMAIN_URL:-}
      - MAX_API_DOMAIN_URL=${MAX_API_DOMAIN_URL:-}
      - MAX_API_HOST=${MAX_API_HOST:-0.0.0.0}
      - MAX_API_PORT=${MAX_API_PORT:-8003}
    ports:
      - "${ADMIN_PANEL_PORT:-8081}:8080"
    depends_on:
      - api
    restart: unless-stopped

  university-api:
    build:
      context: ./university-app
      dockerfile: Dockerfile
    container_name: maxbot_university_api
    environment:
      - UNIVERSITY_API_HOST=${UNIVERSITY_API_HOST:-0.0.0.0}
      - UNIVERSITY_API_PORT=${UNIVERSITY_API_PORT:-8001}
      - UNIVERSITY_API_DOMAIN_URL=${UNIVERSITY_API_DOMAIN_URL:-}
      - UNIVERSITY_DATABASE_URL=${UNIVERSITY_DATABASE_URL:-postgresql://maxbot:maxbot123@postgres:5432/university_db}
    ports:
      - "${UNIVERSITY_API_PORT:-8001}:8001"
    volumes:
      - ./university-app:/app
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  ghost-api:
    build:
      context: ./ghost-app
      dockerfile: Dockerfile
    container_name: maxbot_ghost_api
    environment:
      - GHOST_API_HOST=${GHOST_API_HOST:-0.0.0.0}
      - GHOST_API_PORT=${GHOST_API_PORT:-8004}
      - GHOST_API_DOMAIN_URL=${GHOST_API_DOMAIN_URL:-}
      - GHOST_DATABASE_URL=${GHOST_DATABASE_URL:-postgresql://maxbot:maxbot123@postgres:5432/ghost_db}
    ports:
      - "${GHOST_API_PORT:-8004}:8004"
    volumes:
      - ./ghost-app:/app
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  mini-app:
    build:
      context: ./mini-app
      dockerfile: Dockerfile
    container_name: maxbot_mini_app
    environment:
      - MINI_APP_HOST=${MINI_APP_HOST:-0.0.0.0}
      - MINI_APP_PORT=${MINI_APP_PORT:-8002}
      - MINI_APP_DOMAIN_URL=${MINI_APP_DOMAIN_URL:-}
    ports:
      - "${MINI_APP_PORT:-8002}:8002"
    env_file:
      - .env
    restart: unless-stopped

  cloudpub-init:
    image: alpine:latest
    container_name: maxbot-cloudpub-init
    volumes:
      - ./cloudpub-config:/cloudpub-config
    command: sh -c "mkdir -p /cloudpub-config/cloudpub-api /cloudpub-config/cloudpub-admin-panel /cloudpub-config/cloudpub-university-api /cloudpub-config/cloudpub-mini-app /cloudpub-config/cloudpub-ghost-api && chmod -R 777 /cloudpub-config"
    restart: "no"

  cloudpub-api:
    image: cloudpub/cloudpub:latest-arm64
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    environment:
      - TOKEN=${CLOUDPUB_TOKEN}
      - HTTP=localhost:8003
    command: run
    depends_on:
      api:
        condition: service_started
      cloudpub-init:
        condition: service_completed_successfully
    volumes:
      - ./cloudpub-config/cloudpub-api:/home/cloudpub

  cloudpub-admin-panel:
    image: cloudpub/cloudpub:latest-arm64
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    environment:
      - TOKEN=${CLOUDPUB_TOKEN}
      - HTTP=localhost:8081
    command: run
    depends_on:
      admin-panel:
        condition: service_started
      cloudpub-init:
        condition: service_completed_successfully
    volumes:
      - ./cloudpub-config/cloudpub-admin-panel:/home/cloudpub

  cloudpub-university-api:
    image: cloudpub/cloudpub:latest-arm64
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    environment:
      - TOKEN=${CLOUDPUB_TOKEN}
      - HTTP=localhost:8001
    command: run
    depends_on:
      university-api:
        condition: service_started
      cloudpub-init:
        condition: service_completed_successfully
    volumes:
      - ./cloudpub-config/cloudpub-university-api:/home/cloudpub

  cloudpub-mini-app:
    image: cloudpub/cloudpub:latest-arm64
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    environment:
      - TOKEN=${CLOUDPUB_TOKEN}
      - HTTP=localhost:8002
    command: run
    depends_on:
      mini-app:
        condition: service_started
      cloudpub-init:
        condition: service_completed_successfully
    volumes:
      - ./cloudpub-config/cloudpub-mini-app:/home/cloudpub

  cloudpub-ghost-api:
    image: cloudpub/cloudpub:latest-arm64
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    environment:
      - TOKEN=${CLOUDPUB_TOKEN}
      - HTTP=localhost:8004
    command: run
    depends_on:
      ghost-api:
        condition: service_started
      cloudpub-init:
        condition: service_completed_successfully
    volumes:
      - ./cloudpub-config/cloudpub-ghost-api:/home/cloudpub

volumes:
  postgres_data:

